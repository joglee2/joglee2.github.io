<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Ackordeditor 2.0</title>
  <style>
    body {
      font-family: monospace;
      background-color: #f4f4f4;
      padding: 20px;
    }
    input, textarea, button {
      font-family: monospace;
      font-size: 1em;
    }
    #editor {
      white-space: pre;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      min-height: 400px;
      width: 100%;
      box-sizing: border-box;
      position: relative;
    }
    .line-container {
      margin-bottom: 10px;
    }
    .chord-line, .text-line {
      display: block;
      white-space: pre;
    }
    .chord-line {
      color: blue;
      position: relative;
    }
    .hover-box {
      position: absolute;
      width: 8px;
      height: 1.2em;
      background-color: rgba(255, 230, 130, 0.5);
      pointer-events: none;
    }
    .metadata {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

<h2>Ackordeditor 2.0</h2>

<div class="metadata">
  <label for="title">Titel:</label>
  <input type="text" id="title"><br>
  <label for="composer">Kompositör:</label>
  <input type="text" id="composer"><br>
  <label for="key">Tonart:</label>
  <input type="text" id="key"><br>
</div>

<label for="intro">Intro-ackord:</label><br>
<textarea id="intro" rows="2" style="width: 100%; font-family: monospace;"></textarea><br>

<textarea id="textInput" rows="8" style="width: 100%;" placeholder="Klistra in låttext här..."></textarea>
<br>
<button onclick="loadText()">Ladda in text</button>
<button onclick="transposeChords(1)">Transponera ▲</button>
<button onclick="transposeChords(-1)">Transponera ▼</button>
<button onclick="exportText()">Exportera</button>

<hr>

<div id="editor"></div>

<script>
const scale = ["A", "Bb", "B", "C", "C#", "D", "Eb", "E", "F", "F#", "G", "G#"];
const hoverBox = document.createElement('div');
hoverBox.className = 'hover-box';
let currentChordLine = null;
let hoverPos = 0;

function loadText() {
  const text = document.getElementById('textInput').value.trim();
  const lines = text.split("\n");
  const editor = document.getElementById('editor');
  editor.innerHTML = "";

  const leftPadding = "        "; // 8 mellanslag

  lines.forEach(line => {
    const container = document.createElement('div');
    container.className = 'line-container';

    const chordLine = document.createElement('div');
    chordLine.className = 'chord-line';
    chordLine.textContent = leftPadding + " ".repeat(line.length);

    chordLine.addEventListener('mousemove', function (e) {
      const rect = chordLine.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const pos = Math.floor(x / 8);
      hoverPos = pos;
      currentChordLine = chordLine;
      hoverBox.style.left = (pos * 8) + 'px';
      hoverBox.style.top = (chordLine.offsetTop) + 'px';
      chordLine.appendChild(hoverBox);
    });

    const textLine = document.createElement('div');
    textLine.className = 'text-line';
    textLine.textContent = leftPadding + line;

    container.appendChild(chordLine);
    container.appendChild(textLine);
    editor.appendChild(container);
  });
}

document.addEventListener('keydown', function (e) {
  if (!currentChordLine || e.ctrlKey || e.metaKey) return;

  let key = e.key;
  if (key.length === 1) {
    let input = key.toUpperCase();
    if (e.shiftKey || /^[#bm7\/]$/i.test(key)) {
      input = key;
    }

    const text = currentChordLine.textContent;
    const pre = text.substring(0, hoverPos);
    const post = text.substring(hoverPos + input.length);
    currentChordLine.textContent = pre + input + post;
  }
});

function transposeChords(step) {
  const chordLines = document.querySelectorAll('.chord-line');
  chordLines.forEach(line => {
    line.textContent = transposeLine(line.textContent, step);
  });
}

function transposeLine(line, step) {
  return line.replace(/\b([A-G][b#]?[^/\s]*)\/?([A-G][b#]?)?\b/g, (_, chord, bass) => {
    const transChord = transposeChordRoot(chord, step);
    const transBass = bass ? transposeChordRoot(bass, step) : "";
    return transChord + (transBass ? "/" + transBass : "");
  });
}

function transposeChordRoot(ch, step) {
  const match = ch.match(/^([A-G][b#]?)(.*)/);
  if (!match) return ch;
  const [_, root, suffix] = match;
  const i = scale.indexOf(root);
  if (i === -1) return ch;
  const newRoot = scale[(i + step + scale.length) % scale.length];
  return newRoot + suffix;
}

function exportText() {
  const title = document.getElementById("title").value;
  const composer = document.getElementById("composer").value;
  const key = document.getElementById("key").value;
  const intro = document.getElementById("intro").value;

  const lines = document.querySelectorAll('.line-container');
  let output = `Titel: ${title}\nKompositör: ${composer}\nTonart: ${key}\n\nIntro:\n${intro}\n\n`;

  lines.forEach(container => {
    const chord = container.querySelector('.chord-line').textContent;
    const text = container.querySelector('.text-line').textContent;
    output += chord + "\n" + text + "\n";
  });

  const blob = new Blob([output], { type: "text/plain;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "låttext_med_ackord.txt";
  link.click();
}
</script>

</body>
</html>
