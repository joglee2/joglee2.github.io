<!DOCTYPE html>
<html lang="sv">
<head>
  <meta charset="UTF-8">
  <title>Ackordeditor</title>
  <style>
    body {
      font-family: monospace;
      background-color: #f4f4f4;
      padding: 20px;
    }
    #editor {
      white-space: pre;
      background: #fff;
      padding: 10px;
      border: 1px solid #ccc;
      min-height: 400px;
      width: 100%;
      box-sizing: border-box;
    }
    .line-container {
      margin-bottom: 10px;
    }
    .chord-line, .text-line {
      display: block;
      white-space: pre;
    }
    .chord-line {
      color: blue;
      cursor: pointer;
      min-height: 1em;
    }
    input.chord-input {
      position: absolute;
      font-family: monospace;
      font-size: 1em;
      width: 3em;
    }
    button {
      margin: 5px;
    }
    label {
      display: inline-block;
      width: 80px;
    }
    .metadata {
      margin-bottom: 15px;
    }
  </style>
</head>
<body>

<h2>Ackordeditor</h2>

<div class="metadata">
  <label for="title">Titel:</label>
  <input type="text" id="title"><br>
  <label for="composer">Kompositör:</label>
  <input type="text" id="composer"><br>
  <label for="key">Tonart:</label>
  <input type="text" id="key"><br>
</div>

<textarea id="textInput" rows="10" style="width: 100%;" placeholder="Klistra in låttext här..."></textarea>
<br>
<button onclick="loadText()">Ladda in text</button>
<button onclick="transposeChords(1)">Transponera ▲</button>
<button onclick="transposeChords(-1)">Transponera ▼</button>
<button onclick="exportText()">Exportera</button>

<hr>

<div id="editor"></div>

<script>
const scale = ["A", "Bb", "B", "C", "C#", "D", "Eb", "E", "F", "F#", "G", "G#"];

function loadText() {
  const text = document.getElementById('textInput').value.trim();
  const lines = text.split("\n");
  const editor = document.getElementById('editor');
  editor.innerHTML = "";

  const leftPadding = "        "; // 8 mellanslag

  lines.forEach(line => {
    const container = document.createElement('div');
    container.className = 'line-container';

    const chordLine = document.createElement('div');
    chordLine.className = 'chord-line';
    chordLine.textContent = leftPadding + " ".repeat(line.length);
    chordLine.addEventListener('click', function(e) {
      const rect = chordLine.getBoundingClientRect();
      const x = e.clientX - rect.left;
      const pos = Math.floor(x / 8);
      insertChordInput(chordLine, pos);
    });

    const textLine = document.createElement('div');
    textLine.className = 'text-line';
    textLine.textContent = leftPadding + line;

    container.appendChild(chordLine);
    container.appendChild(textLine);
    editor.appendChild(container);
  });
}

function insertChordInput(chordLine, pos) {
  const input = document.createElement('input');
  input.className = 'chord-input';
  input.style.left = (pos * 8) + 'px';
  input.style.top = '0px';

  chordLine.style.position = 'relative';
  chordLine.appendChild(input);
  input.focus();

  input.addEventListener('blur', function() {
    const val = input.value.trim();
    if (val) {
      const text = chordLine.textContent;
      const newText = text.substring(0, pos) + val + text.substring(pos + val.length);
      chordLine.textContent = newText;
    }
    input.remove();
  });
}

function transposeChords(step) {
  const chordLines = document.querySelectorAll('.chord-line');
  chordLines.forEach(line => {
    let text = line.textContent;

    scale.forEach((note, i) => {
      const regex = new RegExp(`\\b${note}(m|7|maj7|sus4|dim|aug|add9)?\\b`, "g");

      text = text.replace(regex, (match, suffix = "") => {
        const newIndex = (i + step + scale.length) % scale.length;
        return scale[newIndex] + suffix;
      });
    });

    line.textContent = text;
  });
}

function exportText() {
  const title = document.getElementById("title").value;
  const composer = document.getElementById("composer").value;
  const key = document.getElementById("key").value;

  const lines = document.querySelectorAll('.line-container');
  let output = `Titel: ${title}\nKompositör: ${composer}\nTonart: ${key}\n\n`;

  lines.forEach(container => {
    const chord = container.querySelector('.chord-line').textContent;
    const text = container.querySelector('.text-line').textContent;
    output += chord + "\n" + text + "\n";
  });

  const blob = new Blob([output], { type: "text/plain;charset=utf-8" });
  const link = document.createElement("a");
  link.href = URL.createObjectURL(blob);
  link.download = "låttext_med_ackord.txt";
  link.click();
}
</script>

</body>
</html>
